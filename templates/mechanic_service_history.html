<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service History - Auto Service</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #333;
            min-height: 100vh;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background: #2c3e50;
            color: white;
            padding: 20px 0;
        }

        .logo {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid #34495e;
            margin-bottom: 20px;
        }

        .logo h1 {
            font-size: 1.5em;
            color: #3498db;
        }

        .nav-links {
            list-style: none;
        }

        .nav-links li {
            margin: 5px 0;
        }

        .nav-links a {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: #bdc3c7;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .nav-links a:hover,
        .nav-links a.active {
            background: #34495e;
            color: #3498db;
            border-left-color: #3498db;
        }

        .nav-links i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        /* Main Content */
        .main-content {
            padding: 20px;
            background: #ecf0f1;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
        }

        .welcome-section h1 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .welcome-section p {
            color: #7f8c8d;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2em;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 15px;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card.primary { border-top: 4px solid #3498db; }
        .stat-card.success { border-top: 4px solid #27ae60; }
        .stat-card.warning { border-top: 4px solid #f39c12; }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input, .filter-select {
            padding: 10px 15px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
        }

        .search-input {
            width: 300px;
        }

        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .services-table {
            width: 100%;
            border-collapse: collapse;
        }

        .services-table th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .services-table td {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .services-table tr:hover {
            background: #f8f9fa;
        }

        .services-table tr:last-child td {
            border-bottom: none;
        }

        /* Service Type Badges */
        .service-type {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            display: inline-block;
            margin: 2px;
        }

        .type-maintenance { background: #3498db; }
        .type-repair { background: #e74c3c; }
        .type-inspection { background: #f39c12; }
        .type-oil-change { background: #27ae60; }
        .type-tire-rotation { background: #9b59b6; }
        .type-brake-inspection { background: #e67e22; }
        .type-battery-check { background: #16a085; }
        .type-tire { background: #9b59b6; }
        .type-brake { background: #e67e22; }
        .type-electrical { background: #8e44ad; }

        /* Action Buttons */
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin: 0 2px;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-info { background: #9b59b6; color: white; }

        .action-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        /* Loading and Messages */
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .empty-state i {
            font-size: 3em;
            margin-bottom: 15px;
            color: #bdc3c7;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input {
                width: 100%;
            }

            .table-container {
                overflow-x: auto;
            }

            .services-table {
                min-width: 800px;
            }
        }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h1>ðŸ”§ AutoService Pro</h1>
                <small>Mechanic Portal</small>
            </div>
            
            <ul class="nav-links">
                <li><a href="/mechanic/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="/mechanic/appointments"><i class="fas fa-calendar-alt"></i> Appointments</a></li>
                <li><a href="/mechanic/service-history" class="active"><i class="fas fa-history"></i> Service History</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="welcome-section">
                    <h1>Service History</h1>
                    <p>Complete record of all vehicle services performed</p>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">M</div>
                    <div>
                        <strong id="displayName">Mechanic User</strong>
                        <button class="logout-btn" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card primary">
                    <i class="fas fa-tools fa-2x" style="color: #3498db;"></i>
                    <div class="stat-number" id="totalServices">0</div>
                    <div class="stat-label">Total Services</div>
                </div>
                
                <div class="stat-card success">
                    <i class="fas fa-car fa-2x" style="color: #27ae60;"></i>
                    <div class="stat-number" id="uniqueVehicles">0</div>
                    <div class="stat-label">Unique Vehicles</div>
                </div>
                
                <div class="stat-card warning">
                    <i class="fas fa-calendar fa-2x" style="color: #f39c12;"></i>
                    <div class="stat-number" id="thisMonth">0</div>
                    <div class="stat-label">This Month</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <input type="text" class="search-input" id="searchInput" placeholder="Search by plate, owner, or service type..." onkeyup="searchServices()">
                <button class="refresh-btn" onclick="loadServiceHistory()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>

            <!-- Services Table -->
            <div class="table-container">
                <div id="loadingIndicator" class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading service history...
                </div>
                <div id="errorMessage" class="error-message" style="display: none;"></div>
                <div id="emptyState" class="empty-state" style="display: none;">
                    <i class="fas fa-history"></i>
                    <h3>No Service History</h3>
                    <p>No service records found in the system.</p>
                </div>
                
                <table class="services-table" id="servicesTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Service ID</th>
                            <th>Date</th>
                            <th>Vehicle</th>
                            <th>Owner</th>
                            <th>Service Type</th>
                            <th>Mileage</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="servicesBody">
                        <!-- Services will be loaded here -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        let allServices = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ”§ Loading service history...');
            updateUserInfo();
            loadServiceHistory();
        });

        // Update user info
        async function updateUserInfo() {
            try {
                const response = await fetch('/mechanic/status');
                if (response.ok) {
                    const data = await response.json();
                    if (data.logged_in) {
                        document.getElementById('displayName').textContent = data.username || 'User';
                        document.getElementById('userAvatar').textContent = (data.username || 'U').charAt(0).toUpperCase();
                    } else {
                        window.location.href = '/mechanic/login.html';
                    }
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
            }
        }

        // Load service history
        async function loadServiceHistory() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const servicesTable = document.getElementById('servicesTable');
            const emptyState = document.getElementById('emptyState');

            loadingIndicator.style.display = 'block';
            errorMessage.style.display = 'none';
            servicesTable.style.display = 'none';
            emptyState.style.display = 'none';

            try {
                const response = await fetch('/mechanic/api/complete-services');
                const data = await response.json();

                if (data.success) {
                    allServices = data.data;
                    renderServices(allServices);
                    updateStats(allServices);
                } else {
                    throw new Error(data.message);
                }

            } catch (error) {
                console.error('âŒ Error loading service history:', error);
                loadingIndicator.style.display = 'none';
                errorMessage.style.display = 'block';
                errorMessage.textContent = `Failed to load service history: ${error.message}`;
            }
        }

        // Update statistics
        function updateStats(services) {
            document.getElementById('totalServices').textContent = services.length;
            
            const uniqueVehicles = new Set(services.map(service => service.Car_plate)).size;
            document.getElementById('uniqueVehicles').textContent = uniqueVehicles;
            
            const thisMonth = services.filter(service => {
                if (!service.Service_Date) return false;
                const serviceDate = new Date(service.Service_Date);
                const now = new Date();
                return serviceDate.getMonth() === now.getMonth() && 
                       serviceDate.getFullYear() === now.getFullYear();
            }).length;
            document.getElementById('thisMonth').textContent = thisMonth;
        }

        // Render services table
        function renderServices(services) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const servicesTable = document.getElementById('servicesTable');
            const servicesBody = document.getElementById('servicesBody');
            const emptyState = document.getElementById('emptyState');

            loadingIndicator.style.display = 'none';

            if (services.length === 0) {
                emptyState.style.display = 'block';
                servicesTable.style.display = 'none';
                return;
            }

            servicesBody.innerHTML = '';
            servicesTable.style.display = 'table';
            emptyState.style.display = 'none';

            services.forEach(service => {
                const row = document.createElement('tr');
                
                const serviceTypesStr = service.Service_Type || 'Maintenance';
                const serviceTypes = serviceTypesStr.split(', ');
                
                // Create badges for each service type
                const serviceTypeBadges = serviceTypes.map(type => {
                    const typeClass = `type-${type.toLowerCase().replace(/\s+/g, '-')}`;
                    return `<span class="service-type ${typeClass}">${type}</span>`;
                }).join(' ');
                
                const date = new Date(service.Service_Date);
                const formattedDate = service.Service_Date ? date.toLocaleDateString() : 'N/A';

                row.innerHTML = `
                    <td>#${service.Service_id}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <strong>${service.Car_plate}</strong><br>
                        <small>${service.car_model || 'Unknown Model'} â€¢ ${service.car_year || 'N/A'}</small>
                    </td>
                    <td>
                        ${service.Owner_Name || 'Unknown'}<br>
                        <small>${service.PhoneNUMB || ''}</small>
                    </td>
                    <td>
                        ${serviceTypeBadges}
                    </td>
                    <td>${service.Mileage ? service.Mileage.toLocaleString() + ' km' : 'N/A'}</td>
                    <td>${service.Notes || 'No notes'}</td>
                    <td>
                        <button class="action-btn btn-primary" onclick="viewServiceDetails(${service.Service_id})" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn btn-info" onclick="contactOwner('${service.PhoneNUMB}', '${service.Owner_Name}')" title="Contact Owner">
                            <i class="fas fa-phone"></i>
                        </button>
                    </td>
                `;

                servicesBody.appendChild(row);
            });
        }

        // Search services
        function searchServices() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                renderServices(allServices);
                return;
            }

            const filtered = allServices.filter(service => 
                service.Car_plate.toLowerCase().includes(searchTerm) ||
                (service.Owner_Name && service.Owner_Name.toLowerCase().includes(searchTerm)) ||
                (service.Service_Type && service.Service_Type.toLowerCase().includes(searchTerm)) ||
                (service.Notes && service.Notes.toLowerCase().includes(searchTerm))
            );
            
            renderServices(filtered);
        }

        // View service details
        function viewServiceDetails(serviceId) {
            const service = allServices.find(s => s.Service_id === serviceId);
            if (service) {
                const date = new Date(service.Service_Date);
                const formattedDate = service.Service_Date ? date.toLocaleDateString() : 'N/A';
                
                const details = `
Service Details:

ID: #${service.Service_id}
Date: ${formattedDate}
Vehicle: ${service.Car_plate} (${service.car_model} ${service.car_year})
Owner: ${service.Owner_Name}
Phone: ${service.PhoneNUMB || 'N/A'}
Email: ${service.Email || 'N/A'}
Service Type: ${service.Service_Type}
Mileage: ${service.Mileage ? service.Mileage.toLocaleString() + ' km' : 'N/A'}
Notes: ${service.Notes || 'No notes'}
                `.trim();
                
                alert(details);
            }
        }

        // Contact owner
        function contactOwner(phoneNumber, ownerName) {
            if (phoneNumber && phoneNumber !== 'N/A') {
                if (confirm(`Call ${ownerName} at ${phoneNumber}?`)) {
                    window.location.href = `tel:${phoneNumber}`;
                }
            } else {
                alert('No phone number available for this owner.');
            }
        }

        // Logout function
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await fetch('/mechanic/logout', { method: 'POST' });
                    window.location.href = '/mechanic/login.html';
                } catch (error) {
                    alert('Logout failed');
                }
            }
        }
    </script>
</body>
</html>