<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>License Plate Detection</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#1f1f1f; color:#fff; font-family:Arial; padding:20px; text-align:center; }
    .container { max-width:900px; margin:auto; background:#2b2b2b; padding:20px; border-radius:15px; border:1px solid #3498db; }
    .camera-container { margin:20px 0; position:relative; }
    video { width:100%; background:black; border-radius:10px; }
    .focus-overlay { position:absolute; top:50%; left:50%; width:260px; height:100px; transform:translate(-50%,-50%); border:3px solid #00ff88; border-radius:10px; pointer-events:none; }
    .controls { margin-top:20px; display:flex; gap:12px; justify-content:center; }
    button { padding:10px 20px; border:none; border-radius:10px; color:white; background:#3498db; cursor:pointer; font-size:16px; transition:background 0.3s; }
    button:hover { background:#2980b9; }
    #result { margin-top:20px; padding:20px; background:#333; border-radius:10px; }
    .success { background: rgba(0,255,150,0.06); padding:10px; border-left:4px solid #00ff88; }
    .error { background: rgba(255,0,0,0.06); padding:10px; border-left:4px solid red; }
    #manualInput { display:none; margin-top:20px; padding:20px; background:#4a4a4a; border-radius:10px; }
    .action-btn { 
      display: inline-block; 
      margin-top: 15px; 
      padding: 12px 25px; 
      color: white; 
      text-decoration: none; 
      border-radius: 8px; 
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
      margin: 10px 5px;
    }
    .after-service-btn { 
      background: #00cc66; 
    }
    .after-service-btn:hover { 
      background: #00b359; 
    }
    .add-car-btn { 
      background: #e74c3c; 
    }
    .add-car-btn:hover { 
      background: #c0392b; 
    }
    .car-info { 
      background: rgba(52, 152, 219, 0.1); 
      padding: 15px; 
      border-radius: 8px; 
      margin: 15px 0; 
      text-align: left;
    }
    .car-info h3 { 
      color: #3498db; 
      margin-bottom: 10px; 
    }
    .buttons-container {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöó License Plate Recognition</h1>
    <div style="margin-top:10px;">
      <label>API URL:</label>
      <input id="apiUrl" type="text" value="/car/detect" style="width:60%; padding:6px; border-radius:8px; border:none;">
    </div>

    <div class="camera-container">
      <video id="video" autoplay playsinline></video>
      <div class="focus-overlay"></div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <div class="controls">
      <button onclick="captureAndDetect()">üì∏ Detect Plate</button>
      <button onclick="showManualInput()">‚å®Ô∏è Manual Entry</button>
      <button onclick="resetUI()">üîÑ Reset</button>
    </div>

    <div id="loading" style="display:none; margin:12px;">Processing...</div>

    <div id="result">
      <div class="success">Camera Ready ‚Äî press "Detect Plate"</div>
    </div>

    <div id="manualInput">
      <h3>Manual Plate Entry</h3>
      <input id="manualPlate" maxlength="12" placeholder="Type plate here (ABC1234)" style="padding:10px; width:60%; border-radius:8px; border:none;">
      <br><br>
      <button onclick="useManualPlate()">Submit</button>
      <button onclick="hideManualInput()">Cancel</button>
    </div>
  </div>

  <script>
    let stream = null;
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const resultDiv = document.getElementById("result");
    const loading = document.getElementById("loading");

    document.addEventListener("DOMContentLoaded", initializeCamera);

    async function initializeCamera() {
      try {
        if (stream) stopCamera();
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        setResult(`<div class="success">Camera initialized</div>`);
      } catch (err) {
        setResult(`<div class="error">Camera Error: ${err.message}</div>`);
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    }

    function proceedToAfterService(plateNumber) {
      // Store plate in sessionStorage and navigate to after-service form
      sessionStorage.setItem('detectedPlate', plateNumber);
      window.location.href = '/after_service_form.html';
    }

    function proceedToAddCar(plateNumber) {
      // Store plate in sessionStorage and navigate to add car form
      sessionStorage.setItem('detectedPlate', plateNumber);
      window.location.href = '/mechanic/addCar.html';
    }

   async function fetchCarInfo(plateNumber) {
  try {
    // Use the mechanic blueprint endpoint
    const response = await fetch(`/mechanic/api/car/${plateNumber}`);
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('Error fetching car info:', error);
    return { success: false, message: 'Error fetching car information' };
  }
}

    async function captureAndDetect() {
      const apiUrl = document.getElementById("apiUrl").value.trim();
      loading.style.display = "block";
      setResult("");

      const ctx = canvas.getContext("2d");
      canvas.width = video.videoWidth || 1280;
      canvas.height = video.videoHeight || 720;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg", 0.9));
      const formData = new FormData();
      formData.append("image", blob, "frame.jpg");

      try {
        const res = await fetch(apiUrl, { method:"POST", body: formData });
        const data = await res.json();
        
        if (!data.success) {
          setResult(`<div class="error">${data.message || "No plate detected"}</div>`);
        } else {
          const plateNumber = data.plate_number;
          
          // Show initial detection success
          setResult(`
            <div class="success">
              <strong>Plate Detected:</strong><br>
              <h2>${plateNumber}</h2>
              Confidence: ${data.confidence_percent}%
              <br>
              <div style="margin:15px 0;">
                <em>Fetching car information from database...</em>
              </div>
            </div>
          `);

          // Fetch car info from database
          const carInfo = await fetchCarInfo(plateNumber);
          
          if (carInfo.success) {
            // Car exists in database - show car info and after-service button
            const car = carInfo.car_info;
            setResult(`
              <div class="success">
                <strong>‚úÖ Car Found in Database:</strong><br>
                <h2>${plateNumber}</h2>
                
                <div class="car-info">
                  <h3>Car Information:</h3>
                  <strong>Model:</strong> ${car.model || 'Unknown'}<br>
                  <strong>Year:</strong> ${car.year || 'Unknown'}<br>
                  <strong>VIN:</strong> ${car.vin || 'Unknown'}<br>
                  <strong>Owner:</strong> ${car.owner_name || 'Unknown'}<br>
                  <strong>Phone:</strong> ${car.owner_phone || 'Unknown'}<br>
                  ${car.next_oil_change ? `<strong>Next Oil Change:</strong> ${car.next_oil_change}<br>` : ''}
                </div>

                <div class="buttons-container">
                  <button onclick="proceedToAfterService('${plateNumber}')" class="action-btn after-service-btn">
                    üìù Proceed to After-Service Form
                  </button>
                </div>
              </div>
            `);
          } else {
            // Car not found in database - show add car button
            setResult(`
              <div class="success">
                <strong>Plate Detected:</strong><br>
                <h2>${plateNumber}</h2>
                Confidence: ${data.confidence_percent}%
                
                <div class="error" style="margin:15px 0; padding:15px;">
                  <strong>‚ùå Car Not Found in Database</strong><br>
                  This car plate is not registered in our system.
                </div>

                <div class="buttons-container">
                  <button onclick="proceedToAddCar('${plateNumber}')" class="action-btn add-car-btn">
                    üöó Add Car to Database
                  </button>
                </div>
              </div>
            `);
          }
        }
      } catch (err) {
        setResult(`<div class="error">Request Error: ${err.message}</div>`);
      }

      loading.style.display = "none";
    }

    async function useManualPlate() {
      const text = document.getElementById("manualPlate").value.toUpperCase();
      if (!/^[A-Z0-9]{4,12}$/.test(text)) {
        alert("Invalid format. Enter something like ABC1234.");
        return;
      }

      loading.style.display = "block";
      setResult("");

      try {
        // Fetch car info from database for manual entry
        const carInfo = await fetchCarInfo(text);
        
        if (carInfo.success) {
          // Car exists in database
          const car = carInfo.car_info;
          setResult(`
            <div class="success">
              <strong>‚úÖ Car Found in Database:</strong><br>
              <h2>${text}</h2>
              
              <div class="car-info">
                <h3>Car Information:</h3>
                <strong>Model:</strong> ${car.model || 'Unknown'}<br>
                <strong>Year:</strong> ${car.year || 'Unknown'}<br>
                <strong>VIN:</strong> ${car.vin || 'Unknown'}<br>
                <strong>Owner:</strong> ${car.owner_name || 'Unknown'}<br>
                <strong>Phone:</strong> ${car.owner_phone || 'Unknown'}<br>
                ${car.next_oil_change ? `<strong>Next Oil Change:</strong> ${car.next_oil_change}<br>` : ''}
              </div>

              <div class="buttons-container">
                <button onclick="proceedToAfterService('${text}')" class="action-btn after-service-btn">
                  üìù Proceed to After-Service Form
                </button>
              </div>
            </div>
          `);
        } else {
          // Car not found in database
          setResult(`
            <div class="success">
              <strong>Manual Plate Entry:</strong><br>
              <h2>${text}</h2>
              
              <div class="error" style="margin:15px 0; padding:15px;">
                <strong>‚ùå Car Not Found in Database</strong><br>
                This car plate is not registered in our system.
              </div>

              <div class="buttons-container">
                <button onclick="proceedToAddCar('${text}')" class="action-btn add-car-btn">
                  üöó Add Car to Database
                </button>
              </div>
            </div>
          `);
        }
      } catch (error) {
        setResult(`<div class="error">Error: ${error.message}</div>`);
      }

      loading.style.display = "none";
    }

    function showManualInput() {
      document.getElementById("manualInput").style.display = "block";
      stopCamera();
    }

    function hideManualInput() {
      document.getElementById("manualInput").style.display = "none";
      initializeCamera();
    }

    function resetUI() {
      setResult(`<div class="success">Camera Ready</div>`);
      initializeCamera();
    }

    function setResult(html) {
      resultDiv.innerHTML = html;
    }
  </script>
</body>
</html>